#version 410

//======================================================================
//  Phong.vert
//  ・Phong ライティング用の標準メッシュ頂点シェーダー
//  ・シャドウマッピング用にライト空間座標も出力
//======================================================================


//======================================================================
//  Uniforms
//======================================================================

// モデル → ワールド行列
uniform mat4 uWorldTransform;

// ワールド → クリップ行列
uniform mat4 uViewProj;

// ワールド → ライト空間行列（シャドウマップ生成用）
uniform mat4 uLightSpaceMatrix;


//======================================================================
//  Vertex Attributes
//======================================================================

// 頂点座標
layout(location = 0) in vec3 inPosition;
// 法線ベクトル
layout(location = 1) in vec3 inNormal;
// UV（テクスチャ座標）
layout(location = 2) in vec2 inTexCoord;


//======================================================================
//  Varyings（フラグメントへ渡す）
//======================================================================

// UV
out vec2 fragTexCoord;

// ワールド空間の法線
out vec3 fragNormal;

// ワールド空間の頂点座標
out vec3 fragWorldPos;

// ライト空間座標（シャドウマップ参照用）
out vec4 fragPosLightSpace;


//======================================================================
//  main()
//======================================================================
void main()
{
    //------------------------------------------------------------------
    // Step 1 : 頂点座標をワールド空間へ
    //------------------------------------------------------------------
    vec4 worldPos = vec4(inPosition, 1.0) * uWorldTransform;
    fragWorldPos = worldPos.xyz;

    //------------------------------------------------------------------
    // Step 2 : ワールド座標をクリップ空間へ
    //------------------------------------------------------------------
    gl_Position = worldPos * uViewProj;

    //------------------------------------------------------------------
    // Step 3 : 法線をワールド空間で変換（スケールも含める）
    //------------------------------------------------------------------
    fragNormal = normalize(mat3(uWorldTransform) * inNormal);

    //------------------------------------------------------------------
    // Step 4 : UV そのまま渡す
    //------------------------------------------------------------------
    fragTexCoord = inTexCoord;

    //------------------------------------------------------------------
    // Step 5 : ライト空間座標（シャドウマップで使う）
    //------------------------------------------------------------------
    fragPosLightSpace = worldPos * uLightSpaceMatrix;
}
