#version 410 core

//======================================================================
//  RainFront.frag
//  ・画面前面に合成する「雨ストリーク」エフェクト
//  ・スクリーンスペースで動作（カメラ位置に依存しない）
//  ・WeatherComponent の uRainAmount と組み合わせて強さ調整
//======================================================================

out vec4 FragColor;


//======================================================================
//  Uniforms
//======================================================================

// 時間（アニメーション用）
uniform float uTime;

// 画面解像度（スクリーン座標 → 正規化座標用）
uniform vec2 uResolution;

// 雨強度（0 = 無し、1 = 最大）
// WeatherComponent が時間・天候に応じて調整
uniform float uRainAmount;


//======================================================================
//  ハッシュノイズ（ランダム性の種）
//======================================================================
float hash(vec2 p)
{
    return fract(sin(dot(p, vec2(27.619, 57.583))) * 43758.5453);
}


//======================================================================
//  雨ストリーク生成
//
//  ・横方向は密度を高めるために大きくスケール
//  ・縦方向は時間でスクロールさせて「落下」
//  ・細長いハイライトの尻尾を smoothstep で作る
//======================================================================
float rainPattern(vec2 uv)
{
    // 雨の本数を増やす（横方向密度UP）
    uv *= vec2(300.0, 1.0);

    // 雨の落下速度（大きいほど高速に落ちる）
    uv.y += uTime * 8.0;

    // 柱ごとのランダムオフセット
    float id = floor(uv.x);
    float offset = hash(vec2(id, 0.0));

    // 0〜1 の範囲で縦方向ループ
    float y = fract(uv.y + offset);

    // 「細くて白い雨線」を作る
    // ・smoothstep(0,0.01) で細いハイライト
    // ・(1 - y) で下方向に向かってフェード
    float brightness = smoothstep(0.0, 0.01, y) * (1.0 - y);

    return brightness;
}


//======================================================================
//  main()
//======================================================================
void main()
{
    // スクリーンスペースUV
    vec2 uv = gl_FragCoord.xy / uResolution;

    // 雨の強度（ストリークの明るさ）
    float rain = rainPattern(uv);

    // 全体の透明度（画面前面合成用）
    // *0.25 で強すぎる雨を抑制
    float alpha = rain * uRainAmount * 0.25;

    // 雨は白色の縦線
    FragColor = vec4(vec3(1.0), alpha);
}
