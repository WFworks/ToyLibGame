#pragma once

//=============================================================
// プロセスの単一インスタンス実行を保証するためのヘッダ
// ・Windows: Mutex を使用
// ・Unix系: ファイルロック（fcntl/lockf）を使用
//=============================================================

#ifdef _WIN32
#include <windows.h>
#else
#include <fcntl.h>
#include <unistd.h>
#endif

namespace toy {

//-------------------------------------------------------------
// SingleInstance
// ・ToyLib アプリを「多重起動させない」ためのユーティリティ。
// ・最初のインスタンスのみロックを取得でき、2つ目以降は失敗する。
//-------------------------------------------------------------
class SingleInstance
{
private:
#ifdef _WIN32
    HANDLE mMutex;  // Windows: 名前付き Mutex ハンドル
#else
    int mFd;        // Unix系: lock ファイルのファイルディスクリプタ
#endif

    bool mIsLocked; // ロックを取得できたか（＝単一インスタンスとして有効）

public:
    //---------------------------------------------------------
    // コンストラクタ
    // ・プラットフォームごとにロック取得を試みる
    //   成功すれば mIsLocked = true
    //---------------------------------------------------------
    SingleInstance();
    
    //---------------------------------------------------------
    // デストラクタ
    // ・ロック解除（Mutex 解放 or ファイルロック解除）
    //---------------------------------------------------------
    ~SingleInstance();
    
    //---------------------------------------------------------
    // ロック状態問い合わせ
    // ・true = このインスタンスが「唯一の実行中プロセス」
    // ・false = すでに別プロセスが動作中
    //---------------------------------------------------------
    bool IsLocked() const { return mIsLocked; }
};

} // namespace toy
